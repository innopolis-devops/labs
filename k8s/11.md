# K8S Secrets

## Native Approach

Create a secret:

```bash
$ kubectl create secret generic some-secret --from-literal=city='Moscow'
secret/some-secret created
```

Explore the secret:

```bash
$ kubectl describe secret some-secret
Name:         some-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
city:  6 bytes
```

Decode the secret:

```bash
$ kubectl get secret some-secret --template={{.data.city}} | base64 -d
Moscow
```

As we can see, the secret is decoded correctly.

## Helm Approach

Generate GPG key and find its fingerprint to encrypt secrets file:

```bash
gpg --gen-key
gpg --list-keys
```

Encrypt secrets to the YAML file (I put my name and email there):

```bash
sops -p C005E417F321F281CA9D353C062AF61BC8FADCD8 secrets.yaml
```

Create a `secrets.yaml` template, modify `deployment.yaml`, and then check that the templates add our encrypted values correctly:

```plain
$ helm secrets template helm-python ./helm-python -f ./secrets.yaml
...
# Source: helm-python/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: helm-python-secret
  label:
    app: helm-python
type: Opaque
data:
  name: "SWdvciBCZWxvdg=="
  email: "aS5iZWxvdkBpbm5vcG9saXMudW5pdmVyaXN0eQ=="
...
```

Launch our pod adding secrets to the environment:

```plain
$ helm secrets install helm-python ./helm-python -f ./secrets.yaml
[helm-secrets] Decrypt: ./secrets.yaml
NAME: helm-python
LAST DEPLOYED: Mon Nov 14 14:18:01 2022
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
     NOTE: It may take a few minutes for the LoadBalancer IP to be available.
           You can watch the status of by running 'kubectl get --namespace default svc -w helm-python'
  export SERVICE_IP=$(kubectl get svc --namespace default helm-python --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")
  echo http://$SERVICE_IP:80

[helm-secrets] Removed: ./secrets.yaml.dec
```

Now check that the secrets have been added to the environment:

```plain
$ kubectl get pods
NAME                          READY   STATUS    RESTARTS   AGE
helm-python-5b9f448fdc-2gnf9   1/1     Running   0          5s

$ kubectl exec helm-python-5b9f448fdc-2gnf9 -- printenv | grep SECRET
SECRET_EMAIL=i.belov@innopolis.univeristy
SECRET_NAME=Igor Belov
```

Edit the `values.yaml` file to put resource limits, restart everything, and see that the result applied:

```plain
$ kubectl describe pod helm-python-7ff5cbb5bc-xtlt6 | grep -A 5 Limits
  Limits:
    cpu:     100m
    memory:  128Mi
  Requests:
    cpu:      100m
    memory:   128Mi
```