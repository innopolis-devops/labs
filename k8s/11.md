# 11

## K8s secrets and resources

### Create secret using `kubectl`

We will store a password as a secret

```commandline
whutao@Romans-MacBook-Pro k8s % kubectl create secret generic app-password --from-literal=password=admin1234
secret/app-password created
```

```commandline
whutao@Romans-MacBook-Pro k8s % kubectl describe secret app-password
Name:         app-password
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  9 bytes
```

Decode the secret and check that everything is okay

```commandline
whutao@Romans-MacBook-Pro k8s % kubectl get secret app-password --template={{.data.password}} | base64 -d
admin1234
```

### Create secret using `helm`

We install helm plugin for secrets using

```commandline
whutao@Romans-MacBook-Pro k8s % helm plugin install https://github.com/zendesk/helm-secrets.git
```

Generate a key

```commandline
whutao@Romans-MacBook-Pro k8s % gpg --gen-key  
gpg (GnuPG) 2.3.8; Copyright (C) 2021 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Note: Use "gpg --full-generate-key" for a full featured key generation dialog.

GnuPG needs to construct a user ID to identify your key.

Real name: Roman Nabiullin
Email address: r.nabiullin@innopolis.university
You selected this USER-ID:
    "Roman Nabiullin <r.nabiullin@innopolis.university>"

Change (N)ame, (E)mail, or (O)kay/(Q)uit? o
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: revocation certificate stored as '/Users/whutao/.gnupg/openpgp-revocs.d/D04E87A3A8923AD2407A7A4A9B70C46C2A7D5917.rev'
public and secret key created and signed.

pub   ed25519 2022-12-06 [SC] [expires: 2024-12-05]
      D04E87A3A8923AD2407A7A4A9B70C46C2A7D5917
uid                      Roman Nabiullin <r.nabiullin@innopolis.university>
sub   cv25519 2022-12-06 [E] [expires: 2024-12-05]
```

So that it appears in

```commandline
whutao@Romans-MacBook-Pro k8s % gpg --list-keys
gpg: checking the trustdb
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   2  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 2u
gpg: next trustdb check due at 2024-12-05
/Users/whutao/.gnupg/pubring.kbx
--------------------------------

pub   ed25519 2022-12-06 [SC] [expires: 2024-12-05]
      D04E87A3A8923AD2407A7A4A9B70C46C2A7D5917
uid           [ultimate] Roman Nabiullin <r.nabiullin@innopolis.university>
sub   cv25519 2022-12-06 [E] [expires: 2024-12-05]
```

We create a secret using the obtained key

```commandline
whutao@Romans-MacBook-Pro k8s % sops -p D04E87A3A8923AD2407A7A4A9B70C46C2A7D5917 secrets.yaml
```

Check that everything works

```commandline
whutao@Romans-MacBook-Pro k8s % helm secrets view secrets.yaml
password: admin1234
```

We deploy the app again

```commandline
whutao@Romans-MacBook-Pro k8s % helm secrets install helm ./helm -f secrets.yaml
NAME: helm
LAST DEPLOYED: Tue Dec  6 21:59:44 2022
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
     NOTE: It may take a few minutes for the LoadBalancer IP to be available.
           You can watch the status of by running 'kubectl get --namespace default svc -w helm'
  export SERVICE_IP=$(kubectl get svc --namespace default helm --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")
  echo http://$SERVICE_IP:80
secrets.yaml.dec
```

The secret is accessible through

```commandline
whutao@Romans-MacBook-Pro k8s % kubectl get pods                               
NAME                               READY   STATUS    RESTARTS   AGE
app-python-helm-674fccf95c-4h4dh   1/1     Running   0          19m
helm-ff559fd89-m7p9c               0/1     Running   0          11s

whutao@Romans-MacBook-Pro k8s % kubectl exec helm-ff559fd89-m7p9c -- printenv
HOME=/root
...
APP_PYTHON_HELM_SERVICE_HOST=10.100.79.170
MY_PASSWORD=admin1234
...
```

and

```commandline
whutao@Romans-MacBook-Pro k8s % kubectl get secret credentials -o yaml
apiVersion: v1
data:
  password: YWRtaW4xMjM0
kind: Secret
metadata:
  annotations:
    meta.helm.sh/release-name: helm
    meta.helm.sh/release-namespace: default
  creationTimestamp: "2022-12-06T18:59:44Z"
  labels:
    app.kubernetes.io/instance: helm
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: helm
    app.kubernetes.io/version: 1.16.0
    helm.sh/chart: helm-0.1.0
  name: credentials
  namespace: default
  resourceVersion: "1440"
  uid: 8c8907bd-d2cc-4080-951f-096da1795706
type: Opaque

whutao@Romans-MacBook-Pro k8s % echo "YWRtaW4xMjM0" | base64 -d
admin1234
```

## Resource limits

We set resource limits in `values.yaml` and they appear in

```commandline
whutao@Romans-MacBook-Pro k8s % kubectl describe pod helm-ff559fd89-m7p9c                   
Name:             helm-ff559fd89-m7p9c
Namespace:        default
Priority:         0
Service Account:  helm
Node:             minikube/192.168.49.2
Start Time:       Tue, 06 Dec 2022 21:59:44 +0300
Labels:           app.kubernetes.io/instance=helm
                  app.kubernetes.io/name=helm
                  pod-template-hash=ff559fd89
Annotations:      <none>
Status:           Running
IP:               172.17.0.6
IPs:
  IP:           172.17.0.6
Controlled By:  ReplicaSet/helm-ff559fd89
Containers:
  helm:
    Container ID:   docker://2ae8decee02deba5fb4d12014bc66402870026ff2d9731c81266462b7e06cf37
    Image:          whutao/app_python:latest
    Image ID:       docker-pullable://whutao/app_python@sha256:4c315d0013e19aa22d211f50dccd3679e05e1bbaadd6cd5b0b6ac256ac39012e
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Tue, 06 Dec 2022 21:59:47 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:http/ delay=10s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=10s timeout=1s period=10s #success=1 #failure=3
    Environment:
      MY_PASSWORD:  <set to the key 'password' in secret 'credentials'>  Optional: false
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-zl5sb (ro)
```
