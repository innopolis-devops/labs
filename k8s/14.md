# Lab 14

## Description of the stack components

- **Prometheus Operator** — helps to ease the deployment and management of Prometheus and its components within Kubernetes. Also, configures in a native to Kubernetes way
- **Prometheus** — a monitoring and alerting system that gathers metrics in the way that every entry has a related timestamp of capture, and, optionally, labels
- **Alertmanager** — a proxy between the Prometheus server (in this case), and the receiving side (i.e., any integration where we want to receive these alerts). Deduplicates, groups, and routes passing alerts
- **Prometheus node-exporter** — a tool that helps to observe/export kernel and hardware metrics of a node
- **Prometheus Adapter for Kubernetes Metrics APIs** — an adapter that exposes CPU/Memory metrics to k8s that are further used for autoscaling
- **kube-state-metrics** — a service that generates metrics of concrete objects within a k8s infrastructure (i.e., pods, nodes, deployments, services, etc.)
- **Grafana** — a data-visualization platform that helps to organize (with the aid of dashboards, charts, and graphs) various time-series data in an understandable for users way

## Output

`kubectl get po,sts,svc,pvc,cm`:

```text
NAME                                                         READY   STATUS    RESTARTS        AGE
pod/alertmanager-my-test-kube-prometheus-st-alertmanager-0   2/2     Running   1 (68s ago)     110s
pod/app-python-0                                             1/1     Running   0               24m
pod/app-python-1                                             0/1     Running   1 (4m43s ago)   24m
pod/app-python-2                                             0/1     Running   1 (12m ago)     26m
pod/my-test-grafana-6978cff67d-x7swt                         3/3     Running   0               2m53s
pod/my-test-kube-prometheus-st-operator-999f44f89-ntwj5      1/1     Running   0               2m53s
pod/my-test-kube-state-metrics-846789d78f-x7vgl              1/1     Running   0               2m53s
pod/my-test-prometheus-node-exporter-59t6b                   1/1     Running   0               2m53s
pod/prometheus-my-test-kube-prometheus-st-prometheus-0       2/2     Running   0               110s

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-my-test-kube-prometheus-st-alertmanager   1/1     111s
statefulset.apps/app-python                                             1/3     34m
statefulset.apps/prometheus-my-test-kube-prometheus-st-prometheus       1/1     110s

NAME                                              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-operated                     ClusterIP   None             <none>        9093/TCP,9094/TCP,9094/UDP   111s
service/app-python                                ClusterIP   10.100.150.34    <none>        80/TCP                       30h
service/kubernetes                                ClusterIP   10.96.0.1        <none>        443/TCP                      84d
service/my-test-grafana                           ClusterIP   10.101.182.187   <none>        80/TCP                       2m54s
service/my-test-kube-prometheus-st-alertmanager   ClusterIP   10.98.139.203    <none>        9093/TCP                     2m54s
service/my-test-kube-prometheus-st-operator       ClusterIP   10.109.108.28    <none>        443/TCP                      2m54s
service/my-test-kube-prometheus-st-prometheus     ClusterIP   10.107.208.248   <none>        9090/TCP                     2m54s
service/my-test-kube-state-metrics                ClusterIP   10.110.21.194    <none>        8080/TCP                     2m54s
service/my-test-prometheus-node-exporter          ClusterIP   10.100.113.249   <none>        9100/TCP                     2m54s
service/prometheus-operated                       ClusterIP   None             <none>        9090/TCP                     110s

NAME                                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/www-app-python-0   Bound    pvc-47a88cc8-d444-41d6-9a68-4e6be5dd608c   1Gi        RWO            standard       34m
persistentvolumeclaim/www-app-python-1   Bound    pvc-3d90a1b1-5228-4965-8957-40ebf264e030   1Gi        RWO            standard       34m
persistentvolumeclaim/www-app-python-2   Bound    pvc-2c48f8ac-e491-48ec-9dd0-9017958c4b98   1Gi        RWO            standard       34m

NAME                                                                     DATA   AGE
configmap/app-python-configmap                                           1      81m
configmap/kube-root-ca.crt                                               1      84d
configmap/my-test-grafana                                                1      2m55s
configmap/my-test-grafana-config-dashboards                              1      2m55s
configmap/my-test-kube-prometheus-st-alertmanager-overview               1      2m55s
configmap/my-test-kube-prometheus-st-apiserver                           1      2m55s
configmap/my-test-kube-prometheus-st-cluster-total                       1      2m54s
configmap/my-test-kube-prometheus-st-controller-manager                  1      2m54s
configmap/my-test-kube-prometheus-st-etcd                                1      2m55s
configmap/my-test-kube-prometheus-st-grafana-datasource                  1      2m55s
configmap/my-test-kube-prometheus-st-grafana-overview                    1      2m54s
configmap/my-test-kube-prometheus-st-k8s-coredns                         1      2m54s
configmap/my-test-kube-prometheus-st-k8s-resources-cluster               1      2m54s
configmap/my-test-kube-prometheus-st-k8s-resources-namespace             1      2m54s
configmap/my-test-kube-prometheus-st-k8s-resources-node                  1      2m54s
configmap/my-test-kube-prometheus-st-k8s-resources-pod                   1      2m54s
configmap/my-test-kube-prometheus-st-k8s-resources-workload              1      2m54s
configmap/my-test-kube-prometheus-st-k8s-resources-workloads-namespace   1      2m54s
configmap/my-test-kube-prometheus-st-kubelet                             1      2m54s
configmap/my-test-kube-prometheus-st-namespace-by-pod                    1      2m54s
configmap/my-test-kube-prometheus-st-namespace-by-workload               1      2m54s
configmap/my-test-kube-prometheus-st-node-cluster-rsrc-use               1      2m54s
configmap/my-test-kube-prometheus-st-node-rsrc-use                       1      2m54s
configmap/my-test-kube-prometheus-st-nodes                               1      2m54s
configmap/my-test-kube-prometheus-st-nodes-darwin                        1      2m54s
configmap/my-test-kube-prometheus-st-persistentvolumesusage              1      2m54s
configmap/my-test-kube-prometheus-st-pod-total                           1      2m54s
configmap/my-test-kube-prometheus-st-prometheus                          1      2m54s
configmap/my-test-kube-prometheus-st-proxy                               1      2m54s
configmap/my-test-kube-prometheus-st-scheduler                           1      2m54s
configmap/my-test-kube-prometheus-st-workload-total                      1      2m55s
configmap/prometheus-my-test-kube-prometheus-st-prometheus-rulefiles-0   29     110s
```

## Metrics

1. Check how much CPU and Memory your StatefulSet is consuming.
   ![](https://i.imgur.com/ik2aAmj.png)
   ![](https://i.imgur.com/U8LdLtI.png)
2. Check which Pod is using CPU more than others and which is less in the default namespace.
   ![](https://i.imgur.com/h61k0ws.png)
3. Check how much memory is used on your node, in % and mb.
   ![](https://i.imgur.com/63SJ3CG.png)
4. Check how many pods and containers actually ran by the Kubelet service.
   ![](https://i.imgur.com/ouSsYVI.png)
5. Check which Pod is using network more than others and which is less in the default namespace.
   ![](https://i.imgur.com/yKpAazm.png)
6. Check how many alerts
   ![](https://i.imgur.com/2xYQh54.png)

## Init containers

`kubectl exec pod/init-containers -- cat /usr/share/nginx/html/index-new.html`:

```text
Defaulted container "nginx" out of: nginx, fetch (init), permissions (init), override (init)
<html><head></head><body><header>
<title>http://info.cern.ch</title>
</header>

<h1>http://info.cern.ch - home of the first website</h1>
<p>From here you can:</p>
<ul>
<li><a href="http://info.cern.ch/hypertext/WWW/TheProject.html">Browse the first website</a></li>
<li><a href="http://line-mode.cern.ch/www/hypertext/WWW/TheProject.html">Browse the first website using the line-mode browser simulator</a></li>
<li><a href="http://home.web.cern.ch/topics/birth-web">Learn about the birth of the web</a></li>
<li><a href="http://home.web.cern.ch/about">Learn about CERN, the physics laboratory where the web was born</a></li>
</ul>
</body></html>
```
