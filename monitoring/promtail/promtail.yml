server:
    http_listen_port: 9080
    grpc_listen_port: 0

positions:
 filename: /var/lib/promtail/positions/positions.yaml

clients:
 - url: http://loki:3100/api/prom/push

scrape_configs:
 - job_name: docker-logs

   static_configs:
     - targets:
         - localhost
       labels:
         job: docker
         __path__: /var/lib/docker/containers/*/*log

   pipeline_stages:
     - json:
         expressions:
           log:
           stream: stream
           attrs: attrs
           tag: attrs.tag
           time: time

     - timestamp:
         source: time
         format: RFC3339Nano

     - regex:
         expression: ^(?P<image_name>([^|]+))\|(?P<container_name>([^|]+))$
         source: "tag"

     - labels:
         tag:
         image_name:
         container_name:

     - match:
         selector: '{job="docker",container_name="",image_name=""}'
         action: drop